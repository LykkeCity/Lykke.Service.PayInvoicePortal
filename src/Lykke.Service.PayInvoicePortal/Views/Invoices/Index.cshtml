@using Lykke.Service.PayInvoicePortal.Models.Invoices
@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization

@model Lykke.Service.PayInvoicePortal.Models.Invoices.IndexViewModel
@{
    ViewData["Title"] = "Invoice - " + Model.Invoice.Number;

    const string partialPathWithAuthor = "/Views/Partials/HistoryRowTemplateWithAuthor.cshtml";
    const string partialPathOther = "/Views/Partials/HistoryRowTemplateOther.cshtml";
    const string partialPathError = "/Views/Partials/HistoryRowTemplateError.cshtml";
}

@if (User.Identity.IsAuthenticated)
{
    @await Html.PartialAsync("Partials/InvoicesNav")
}

<div data-ng-controller="invoiceEditCtrl as vm" ng-cloak>
    @await Html.PartialAsync("Partials/InvoiceEditTemplate", new InvoiceEditTemplateModel { IsNewInvoice = false })
</div>

@await Html.PartialAsync("/Views/Partials/InvoiceInfo.cshtml")

<article class="content"
         data-ng-controller="invoiceDetailsCtrl as vm"
         data-ng-init="vm.handlers.init(@JsonConvert.SerializeObject(Model.Invoice, new JsonSerializerSettings { ContractResolver = new DefaultContractResolver{NamingStrategy = new CamelCaseNamingStrategy()} }))"
         ng-cloak>
    <section class="section section--padding">
        <div class="container">
            <div class="relative hidden-xs hidden-sm">
                <a onclick="history.go(-1)" class="btn btn--link btn_back" style="left: 0">
                    <i class="icon icon--back_arrow"></i>
                    Back
                </a>
            </div>
            <div class="row">
                <div class="col-md-8 automargin">
                    <div class="invoice_page">
                        <div class="invoice_header">
                            <div class="row">
                                <div data-ng-class="vm.form.allowPay ? 'col-md-8' : 'col-md-12'">
                                    <h1 class="page__title">Invoice #{{vm.model.number}}</h1>
                                    <div class="invoice_header__link" data-ng-if="vm.form.allowPay">
                                        <a data-ng-href="{{vm.model.url}}" data-ng-bind="vm.model.url"></a>
                                        <button class="btn btn--icon _copy" type="button" data-copy="vm.model.url" data-title="Copied!">
                                            <i class="btn__svg_icon svg_icon svg_icon--copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4" data-ng-if="vm.form.allowPay">
                                    <div class="invoice_info__qr">
                                        <img data-ng-src="https://chart.googleapis.com/chart?chs=130x130&chld=L|0&cht=qr&chl={{vm.model.url}}" alt="qr" width="130" height="130">
                                    </div>
                                </div>
                            </div>
                            <div class="invoice_header__desc">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="invoice_header__data" data-ng-bind="vm.model.dueDate.format('LL')"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="invoice_controls">
                                            <button class="invoice_controls__btn btn btn--flat btn--default btn-sm pull-left" type="button"
                                                    data-ng-if="vm.form.allowEdit"
                                                    data-ng-click="vm.handlers.edit()">
                                                <i class="btn__svg_icon svg_icon svg_icon--edit svg_icon--margin"></i>
                                                Edit
                                            </button>
                                            <button class="invoice_controls__btn btn btn--flat btn--default btn-sm pull-left" type="button"
                                                    data-ng-if="vm.form.allowDelete"
                                                    data-ng-click="vm.handlers.remove()">
                                                <i class="btn__svg_icon svg_icon svg_icon--delete svg_icon--margin"></i>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset_link_list asset_link_list--thin">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Client</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.client"></div>
                                        </div>
                                    </div>
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Client's Email</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.email"></div>
                                        </div>
                                    </div>
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Status</div>
                                            <div class="asset_link__desc">
                                                <span class="label" data-ng-class="vm.handlers.getStatusCss(vm.model.status)" data-ng-bind="vm.model.status"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Amount</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.amount | nzcurrency : vm.model.settlementAssetAccuracy"></div>
                                        </div>
                                    </div>
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Currency</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.settlementAssetDisplay"></div>
                                        </div>
                                    </div>
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Pay due date</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.dueDate.format('LL')"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12" data-ng-if="vm.model.note">
                                    <div class="asset_link">
                                        <div class="asset_link__info">
                                            <div class="asset_link__title">Note</div>
                                            <div class="asset_link__desc" data-ng-bind="vm.model.note"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div data-ng-if="vm.form.allowEdit">
                            <div class="form_header">
                                <button type="button" class="btn btn-sm btn-primary pull-right" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.rtf" ngf-multiple="true" data-ngf-select="vm.handlers.upload($files)"
                                        data-ng-disabled="vm.form.blocked">Add File</button>
                                <h3>Attachment</h3>
                            </div>
                            <div class="attachment_list attachment_list--download" data-ng-show="vm.model.files && vm.model.files.length > 0">
                                <div class="asset_link_list">
                                    <div class="asset_link asset_link--alt" data-ng-repeat="file in vm.model.files">
                                        <div class="asset_link__icon">
                                            <div class="asset_icon asset_icon--red" data-ng-bind="vm.handlers.getFileExtension(file.name)" data-ng-click="vm.handlers.getFile(file)"></div>
                                        </div>
                                        <div class="asset_link__action">
                                            <button class="btn btn--icon" data-ng-click="vm.handlers.getFile(file)">
                                                <i class="btn__svg_icon svg_icon svg_icon--upload"></i>
                                            </button>
                                            <button class="btn btn--icon" data-ng-click="vm.handlers.deleteFile(file)">
                                                <i class="btn__svg_icon svg_icon svg_icon--delete"></i>
                                            </button>
                                        </div>
                                        <div class="asset_link__info">
                                            <div class="asset_link__title" data-ng-bind="file.name" data-ng-click="vm.handlers.getFile(file)"></div>
                                            <div class="asset_link__desc" data-ng-bind="vm.handlers.getFileSize(file.size)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="hint" data-ng-show="!vm.model.files || vm.model.files.length === 0">No files</div>
                        </div>
                        <div data-ng-if="!vm.form.allowEdit && vm.model.files && vm.model.files.length > 0">
                            <div class="form_header">
                                <h3>Attachment</h3>
                            </div>
                            <div class="attachment_list attachment_list--download">
                                <div class="asset_link_list">
                                    <div class="asset_link asset_link--alt" data-ng-repeat="file in vm.model.files">
                                        <div class="asset_link__icon">
                                            <div class="asset_icon asset_icon--red" data-ng-bind="vm.handlers.getFileExtension(file.name)" data-ng-click="vm.handlers.getFile(file)"></div>
                                        </div>
                                        <div class="asset_link__action">
                                            <button class="btn btn--icon" data-ng-click="vm.handlers.getFile(file)">
                                                <i class="btn__svg_icon svg_icon svg_icon--upload"></i>
                                            </button>
                                        </div>
                                        <div class="asset_link__info">
                                            <div class="asset_link__title" data-ng-bind="file.name" data-ng-click="vm.handlers.getFile(file)"></div>
                                            <div class="asset_link__desc" data-ng-bind="vm.handlers.getFileSize(file.size)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="blockchain_settlement_btn" data-ng-if="vm.form.showBcnLink && vm.form.isEthereumPaymentAsset">
                            <a data-ng-href="@Model.EthereumBlockchainExplorerUrl/address/{{vm.model.walletAddress}}#tokentxns" class="btn btn--flat" target="_blank">
                                <img src="/img/bl_explorer_logo.svg" width="40" alt="bl_explorer_logo">
                                <span>Blockchain Settlement</span>
                            </a>
                        </div>
                        <div class="blockchain_settlement_btn" data-ng-if="vm.form.showBcnLink && !vm.form.isEthereumPaymentAsset">
                            <a data-ng-href="@Model.BlockchainExplorerUrl/address/{{vm.model.walletAddress}}" class="btn btn--flat" target="_blank">
                                <img src="/img/bl_explorer_logo.svg" width="40" alt="bl_explorer_logo">
                                <span>Blockchain Settlement</span>
                            </a>
                        </div>

                        <div class="form_header" data-ng-if="vm.model.history && vm.model.history.length > 0">
                            <h3>History</h3>
                        </div>

                        <div class="history_list" data-ng-if="vm.model.history && vm.model.history.length > 0">
                            <div class="history_item" data-ng-repeat="item in vm.model.history" data-ng-include="'historyRowTemplate-' + item.status">
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
</article>
<script type="text/ng-template" id="historyRowTemplate-Draft">
    @await Html.PartialAsync(partialPathWithAuthor, new HistoryRowTemplateModel
    {
        HistoryItemText = "Created"
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Removed">
    @await Html.PartialAsync(partialPathWithAuthor, new HistoryRowTemplateModel
    {
        HistoryItemText = "Removed"
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Unpaid">
    @await Html.PartialAsync(partialPathWithAuthor, new HistoryRowTemplateModel
    {
        HistoryItemText = "{{item.settlementAmount | nzcurrency : item.settlementAssetAccuracy}} " +
                           "{{item.settlementAsset}} to be paid due {{item.dueDate.format('LL')}}"
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Paid">
    @await Html.PartialAsync(partialPathOther, new HistoryRowTemplateModel
    {
        HistoryItemImg = "history_item__img--success",
        HistoryItemIcon = "icon--check_thin",
        HistoryItemTitle = "Payment",
        HistoryItemText = GetPaidText()
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-InProgress">
    @await Html.PartialAsync(partialPathOther, new HistoryRowTemplateModel
    {
        HistoryItemImg = "history_item__img--success",
        HistoryItemIcon = "icon--check_thin",
        HistoryItemTitle = "In Progress",
        HistoryItemText = "Transferred {{item.settlementAmount | nzcurrency : item.settlementAssetAccuracy}} " +
                          "{{item.settlementAsset}} to LykkePay's account for settlement."
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Refunded">
    @await Html.PartialAsync(partialPathOther, new HistoryRowTemplateModel
    {
        HistoryItemImg = "history_item__img--refund",
        HistoryItemIcon = "icon--move_to_thin",
        HistoryItemTitle = "Refund",
        HistoryItemText = "Refunded {{item.refundAmount | nzcurrency : item.paymentAssetAccuracy}} " +
                          "{{item.paymentAsset}} to {{item.refundWalletAddress}}."
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Underpaid">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemText = GetPaidText()
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-Overpaid">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemText = GetPaidText()
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-LatePaid">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemText = GetPaidText()
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-NotConfirmed">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemText = "Transfer hasn't been confirmed"
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-InternalError">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemText = "Internal error occurred"
    })
</script>
<script type="text/ng-template" id="historyRowTemplate-PastDue">
    @await Html.PartialAsync(partialPathError, new HistoryRowTemplateModel
    {
        HistoryItemTitle = "PastDue",
        HistoryItemText = "Payment due date expired"
    })
</script>

@functions {

    private string GetPaidText()
    {
        return "Transferred {{item.paidAmount | nzcurrency : item.paymentAssetAccuracy}} " +
               "{{item.paymentAsset}} from {{item.sourceWalletAddresses.join(', ')}}, " +
               "expected {{item.paymentAmount | nzcurrency : item.paymentAssetAccuracy}} {{item.paymentAsset}}. " +
               "Exchange rate 1 {{item.paymentAsset}} = {{item.exchangeRate | nzcurrency :  item.settlementAssetAccuracy}} {{item.settlementAsset}}.";
    }

}